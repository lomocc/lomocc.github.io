---
title: Kubeadm
tag: devops
---

# 使用 Kubeadm 在 CentOS 7 部署 Kubernetes 集群

## 安装 `kubeadm`

* 配置 `yum` 源
  ```shell
  $ cat <<EOF > /etc/yum.repos.d/virt7-container-common-candidate.repo
  [virt7-container-common-candidate]
  name=virt7-container-common-candidate
  baseurl=http://cbs.centos.org/repos/virt7-container-common-candidate/x86_64/os/
  enabled=0
  gpgcheck=0
  # See CentOS-extras.repo - change that first, then make this match.
  #exclude=
  EOF
  ```
* 安装 `kubeadm`
  ```shell
  $ yum -y install --enablerepo=virt7-container-common-candidate kubernetes-kubeadm
  ```

## 设置 docker 代理

如果`Node` 节点已经安装了别的版本的 `Docker` ，可能需要先卸载掉。
如果无法访问 `gcr.io`，则需要配置 [Docker 代理]({{ site.baseurl }}{% link _posts/2017-12-04-docker-proxy.md %})

## 初始化 `master`
  
  这里需要根据网络组件来设置 `--pod-network-cidr` 参数，常见的有：
  
|网络组件名|--pod-network-cidr|
|-|-|
|flannel|10.244.0.0/16|
|calico|192.168.0.0/16|

  ```
  $ kubeadm init --pod-network-cidr 10.244.0.0/16 --kubernetes-version 1.8.4
  ```
  `--kubernetes-version` 是防止kubeadm 去墙外获取版本，如果能够确定版本最好。
## 安装网络组件

  可选组件列表：
  [addons](https://kubernetes.io/docs/concepts/cluster-administration/addons/)
  
  ```shell
  $ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  ```
  
  我在这一步安装过程中 `kube-dns` 无法启动，后来发现是 cni 的 bug，`cni 网段` 和 `flannel 网段` 不一致。
  找到 `cni 网卡` 删除，重新初始化即可。  

  ```shell
  $ ip link delete cni0
  ```  

## 加入 `node`
  
```shell
$ kubeadm join --token f053b2.ed3946bb736a9e4c 10.82.12.47:6443 --discovery-token-ca-cert-hash sha256:45e48f80f3b29f66547958fdb2ecbc096c9a30afb3453d109fa94495310f429d
```

要把 `master` 当做 `node` 节点需要执行以下命令:

```shell
$ kubectl taint nodes --all node-role.kubernetes.io/master-
```
